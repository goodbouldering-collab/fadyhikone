# æŠ€è¡“ä»•æ§˜æ›¸ - ãƒ•ã‚¡ãƒ‡ã‚£ãƒ¼å½¦æ ¹

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°ãªæŠ€è¡“ä»•æ§˜ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€å…¨ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

## ğŸ“‹ ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
2. [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ](#ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ )
3. [ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä»•æ§˜](#ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä»•æ§˜)
4. [ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä»•æ§˜](#ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä»•æ§˜)
5. [AIçµ±åˆä»•æ§˜](#aiçµ±åˆä»•æ§˜)
6. [èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#èªè¨¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
7. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)

---

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ index.  â”‚  â”‚ mypage. â”‚  â”‚ admin.  â”‚         â”‚
â”‚  â”‚ html    â”‚  â”‚ html    â”‚  â”‚ html    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Cloudflare Pages      â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚  â”‚  Hono Framework  â”‚   â”‚
        â”‚  â”‚  (TypeScript)    â”‚   â”‚
        â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â”‚       â”‚ API Routes      â”‚
        â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚  â”‚   D1    â”‚ â”‚   R2   â”‚ â”‚
        â”‚  â”‚Database â”‚ â”‚Storage â”‚ â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  External APIs    â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚ â”‚ Google OAuth  â”‚ â”‚
        â”‚ â”‚ Gemini AI     â”‚ â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Presentation Layer              â”‚  â† HTML/CSS/JS
â”‚  - index.html (ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸)      â”‚
â”‚  - mypage.html (ãƒã‚¤ãƒšãƒ¼ã‚¸)       â”‚
â”‚  - admin.html (ç®¡ç†ç”»é¢)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Layer                        â”‚  â† Hono Routes
â”‚  - /api/auth                      â”‚
â”‚  - /api/health-logs               â”‚
â”‚  - /api/advices                   â”‚
â”‚  - /api/announcements             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Business Logic Layer            â”‚  â† TypeScript
â”‚  - Authentication                 â”‚
â”‚  - Data Validation                â”‚
â”‚  - AI Integration                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Layer                       â”‚  â† D1 + R2
â”‚  - Database (D1)                  â”‚
â”‚  - File Storage (R2)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
furdi-hikone/
â”‚
â”œâ”€â”€ .git/                          # Gitãƒªãƒã‚¸ãƒˆãƒª
â”œâ”€â”€ .github/                       # GitHub Actions
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ deploy.yml             # è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
â”‚
â”œâ”€â”€ node_modules/                  # ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
â”‚
â”œâ”€â”€ src/                           # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ index.tsx                  # ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ renderer.tsx               # HTMLãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/                    # APIãƒ«ãƒ¼ãƒˆ
â”‚   â”‚   â”œâ”€â”€ auth.ts                # èªè¨¼API
â”‚   â”‚   â”œâ”€â”€ health-logs.ts         # å¥åº·ãƒ­ã‚°API
â”‚   â”‚   â”œâ”€â”€ advices.ts             # ã‚¢ãƒ‰ãƒã‚¤ã‚¹API
â”‚   â”‚   â”œâ”€â”€ comments.ts            # ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¡ãƒ³ãƒˆAPI
â”‚   â”‚   â”œâ”€â”€ announcements.ts       # ãŠçŸ¥ã‚‰ã›API
â”‚   â”‚   â”œâ”€â”€ opinions.ts            # è³ªå•ãƒ»ç›¸è«‡API
â”‚   â”‚   â”œâ”€â”€ inquiries.ts           # ãŠå•ã„åˆã‚ã›API
â”‚   â”‚   â”œâ”€â”€ admin.ts               # ç®¡ç†è€…API
â”‚   â”‚   â””â”€â”€ settings.ts            # ã‚·ã‚¹ãƒ†ãƒ è¨­å®šAPI
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/                       # ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
â”‚   â”‚   â”œâ”€â”€ auth.ts                # èªè¨¼ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â”œâ”€â”€ jwt.ts                 # JWTå‡¦ç†
â”‚   â”‚   â””â”€â”€ db.ts                  # DBæ¥ç¶š
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                     # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â””â”€â”€ jwt.ts                 # JWTé–¢é€£
â”‚   â”‚
â”‚   â”œâ”€â”€ types/                     # å‹å®šç¾©
â”‚   â”‚   â””â”€â”€ index.ts               # å…±é€šå‹å®šç¾©
â”‚   â”‚
â”‚   â””â”€â”€ types.ts                   # è¿½åŠ å‹å®šç¾©
â”‚
â”œâ”€â”€ public/                        # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ index.html                 # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ mypage.html                # ãƒã‚¤ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ admin.html                 # ç®¡ç†ç”»é¢
â”‚   â”œâ”€â”€ favicon.ico                # ãƒ•ã‚¡ãƒ“ã‚³ãƒ³
â”‚   â”‚
â”‚   â””â”€â”€ static/                    # é™çš„ã‚¢ã‚»ãƒƒãƒˆ
â”‚       â”œâ”€â”€ app.js                 # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸JS (144KB)
â”‚       â”œâ”€â”€ mypage.js              # ãƒã‚¤ãƒšãƒ¼ã‚¸JS
â”‚       â”œâ”€â”€ admin.js               # ç®¡ç†ç”»é¢JS
â”‚       â””â”€â”€ utils.js               # å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£JS
â”‚
â”œâ”€â”€ migrations/                    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ 0001_initial_schema.sql
â”‚   â”œâ”€â”€ 0002_add_advices.sql
â”‚   â”œâ”€â”€ 0003_add_staff_comments.sql
â”‚   â”œâ”€â”€ 0004_add_announcements.sql
â”‚   â”œâ”€â”€ 0005_add_opinion_box.sql
â”‚   â”œâ”€â”€ 0006_add_inquiries.sql
â”‚   â”œâ”€â”€ 0007_add_settings.sql
â”‚   â”œâ”€â”€ 0008_add_meal_photos.sql
â”‚   â”œâ”€â”€ 0009_add_ai_fields.sql
â”‚   â”œâ”€â”€ 0010_optimize_user_profile.sql
â”‚   â””â”€â”€ meta/                      # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
â”‚
â”œâ”€â”€ dist/                          # ãƒ“ãƒ«ãƒ‰å‡ºåŠ›
â”‚   â”œâ”€â”€ _worker.js                 # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿Worker (73KB)
â”‚   â”œâ”€â”€ _routes.json               # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â””â”€â”€ static/                    # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰
â”‚
â”œâ”€â”€ .wrangler/                     # Wranglerä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â””â”€â”€ state/v3/d1/               # ãƒ­ãƒ¼ã‚«ãƒ«D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”‚
â”œâ”€â”€ .dev.vars                      # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒå¤‰æ•°ï¼ˆGité™¤å¤–ï¼‰
â”œâ”€â”€ .gitignore                     # Gité™¤å¤–è¨­å®š
â”œâ”€â”€ package.json                   # NPMè¨­å®š
â”œâ”€â”€ package-lock.json              # ä¾å­˜é–¢ä¿‚ãƒ­ãƒƒã‚¯
â”œâ”€â”€ tsconfig.json                  # TypeScriptè¨­å®š
â”œâ”€â”€ vite.config.ts                 # Viteè¨­å®š
â”œâ”€â”€ wrangler.jsonc                 # Cloudflareè¨­å®š
â”œâ”€â”€ ecosystem.config.cjs           # PM2è¨­å®š
â”‚
â”œâ”€â”€ README.md                      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
â”œâ”€â”€ COMPLETE_DOCUMENTATION.md      # å®Œå…¨ä½¿ç”¨æ›¸ï¼ˆæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
â”œâ”€â”€ DATABASE_SETUP_GUIDE.md        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
â””â”€â”€ TECHNICAL_SPECIFICATION.md     # æŠ€è¡“ä»•æ§˜æ›¸ï¼ˆæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
```

---

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä»•æ§˜

### HTMLãƒ•ã‚¡ã‚¤ãƒ«

#### 1. public/index.htmlï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼‰
- **ç›®çš„**: ãƒ­ã‚°ã‚¤ãƒ³å‰å¾Œã®ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã€å¥åº·ãƒ­ã‚°å…¥åŠ›
- **ä¸»è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³**:
  - Heroï¼ˆãƒ­ã‚°ã‚¤ãƒ³å‰: ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ã€ãƒ­ã‚°ã‚¤ãƒ³å¾Œ: ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºï¼‰
  - å¥åº·ãƒ­ã‚°å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
  - ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
  - Q&Aè¡¨ç¤ºï¼ˆå›ç­”æ¸ˆã¿è³ªå•ï¼‰
  - ãŠçŸ¥ã‚‰ã›è¡¨ç¤º
- **ä¾å­˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:
  - `/static/app.js` (144KB)
  - `/static/utils.js`
- **å¤–éƒ¨CDN**:
  - Tailwind CSS
  - Font Awesome
  - Axios
  - Day.js
  - SweetAlert2

#### 2. public/mypage.htmlï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ï¼‰
- **ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã€ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç¢ºèª
- **ä¸»è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³**:
  - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
  - ã‚¢ãƒ‰ãƒã‚¤ã‚¹ä¸€è¦§ï¼ˆAI/ã‚¹ã‚¿ãƒƒãƒ•ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼‰
  - å¥åº·ãƒ‡ãƒ¼ã‚¿ã‚°ãƒ©ãƒ•ï¼ˆChart.jsï¼‰
  - è³ªå•ãƒ»ç›¸è«‡æŠ•ç¨¿
- **ä¾å­˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:
  - `/static/mypage.js`
  - `/static/utils.js`
- **å¤–éƒ¨CDN**:
  - Chart.jsï¼ˆã‚°ãƒ©ãƒ•æç”»ï¼‰
  - ãã®ä»–ã¯index.htmlã¨åŒæ§˜

#### 3. public/admin.htmlï¼ˆç®¡ç†ç”»é¢ï¼‰
- **ç›®çš„**: ä¼šå“¡ç®¡ç†ã€ã‚¢ãƒ‰ãƒã‚¤ã‚¹ä½œæˆã€ãŠçŸ¥ã‚‰ã›ç®¡ç†
- **ä¸»è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³**:
  - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆçµ±è¨ˆæƒ…å ±ï¼‰
  - ä¼šå“¡ç®¡ç†ï¼ˆä¸€è¦§ã€è©³ç´°ã€æ¤œç´¢ï¼‰
  - ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç®¡ç†
  - ãŠçŸ¥ã‚‰ã›ç®¡ç†
  - è³ªå•ãƒ»ç›¸è«‡ç®¡ç†
  - ãŠå•ã„åˆã‚ã›ç®¡ç†
  - ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
- **ä¾å­˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:
  - `/static/admin.js`
  - `/static/utils.js`

### JavaScriptãƒ•ã‚¡ã‚¤ãƒ«

#### 1. public/static/app.jsï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

**ä¸»è¦é–¢æ•°**:
```javascript
// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', async () => {
  await checkAuth();
  await loadAnnouncements();
  renderPage();
  if (currentUser) {
    await loadAdvices();
    await loadTodayAdvices();
    await loadUnreadCount();
    await loadLogForDate(selectedDate);
    await loadLatestStaffComment();
    await loadOpinions();
  }
});

// èªè¨¼
async function checkAuth()
async function loginWithGoogle(credential)
function getToken()
function setToken(token)
function removeToken()

// ãƒ‡ãƒ¼ã‚¿å–å¾—
async function loadAnnouncements()
async function loadAdvices()
async function loadTodayAdvices()
async function loadUnreadCount()
async function loadLogForDate(date)
async function loadLatestStaffComment()
async function loadOpinions()

// UIæç”»
function renderPage()
function renderHero()
function renderHealthLogForm()
function renderStaffCommentSection()
function renderQASection()

// å¥åº·ãƒ­ã‚°æ“ä½œ
async function saveHealthLog()
function updateBMIDisplay()
async function captureMealPhoto(mealType)
async function analyzeMealPhoto(mealType)
function selectExercisePreset(type, minutes)

// ãŠçŸ¥ã‚‰ã›æ“ä½œ
function showAnnouncementDetail(id)
function showAllAnnouncements()

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function scrollToSection(sectionId)
async function apiCall(url, options = {})
```

**çŠ¶æ…‹ç®¡ç†**:
```javascript
let currentUser = null;              // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼
let advices = [];                    // å…¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹
let unreadAdviceCount = 0;           // æœªèª­ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ•°
let todayLog = null;                 // ä»Šæ—¥ã®å¥åº·ãƒ­ã‚°
let announcements = [];              // ãŠçŸ¥ã‚‰ã›ä¸€è¦§
let latestStaffComment = null;       // æœ€æ–°ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¡ãƒ³ãƒˆ
let selectedDate = null;             // é¸æŠæ—¥ä»˜
let opinions = [];                   // è³ªå•ãƒ»ç›¸è«‡ãƒ‡ãƒ¼ã‚¿
let mealData = {                     // é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿
  breakfast: { photos: [], calories: 0, protein: 0, fat: 0, carbs: 0 },
  lunch: { photos: [], calories: 0, protein: 0, fat: 0, carbs: 0 },
  dinner: { photos: [], calories: 0, protein: 0, fat: 0, carbs: 0 }
};
```

#### 2. public/static/mypage.jsï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

**ä¸»è¦é–¢æ•°**:
```javascript
// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', async () => {
  await checkAuth();
  if (!currentUser) {
    window.location.href = '/';
    return;
  }
  await loadAdvices();
  await loadUserLogs();
  await loadMyOpinions();
  renderPage();
  renderCharts();
});

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
async function loadProfile()
async function saveProfile()

// ã‚¢ãƒ‰ãƒã‚¤ã‚¹
async function loadAdvices(filter = 'all')
async function markAdviceAsRead(id)
function filterAdvices(source)

// ã‚°ãƒ©ãƒ•
function renderCharts()
function renderWeightChart(data)
function renderCaloriesChart(data)
function renderExerciseChart(data)
function renderConditionChart(data)

// è³ªå•ãƒ»ç›¸è«‡
async function loadMyOpinions()
async function submitOpinion(question)
```

#### 3. public/static/admin.jsï¼ˆç®¡ç†ç”»é¢ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

**ä¸»è¦é–¢æ•°**:
```javascript
// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', async () => {
  await checkAuth();
  if (!currentUser || !['admin', 'superadmin'].includes(currentUser.role)) {
    window.location.href = '/';
    return;
  }
  await loadDashboard();
  renderAdminPage();
});

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
async function loadDashboard()
function renderStats(stats)

// ä¼šå“¡ç®¡ç†
async function loadUsers(search = '', role = '')
async function loadUserDetail(userId)
async function updateUserRole(userId, newRole)

// ã‚¢ãƒ‰ãƒã‚¤ã‚¹ä½œæˆ
async function createAdvice(userId, type, title, content, logDate)

// ãŠçŸ¥ã‚‰ã›ç®¡ç†
async function createAnnouncement(title, content, imageUrl, isPublished)
async function updateAnnouncement(id, data)
async function deleteAnnouncement(id)

// è³ªå•ãƒ»ç›¸è«‡ç®¡ç†
async function loadPendingOpinions()
async function answerOpinion(id, answer, answeredBy)

// ãŠå•ã„åˆã‚ã›ç®¡ç†
async function loadInquiries(status = 'all')
async function replyToInquiry(id, reply)
async function updateInquiryStatus(id, status)

// ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
async function loadSettings()
async function updateSetting(key, value)
```

#### 4. public/static/utils.jsï¼ˆå…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼‰

```javascript
// APIå‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼
async function apiCall(url, options = {}) {
  const token = getToken();
  const headers = {
    'Content-Type': 'application/json',
    ...options.headers
  };
  
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }
  
  try {
    const response = await axios({
      url,
      method: options.method || 'GET',
      headers,
      data: options.body,
      ...options
    });
    return response.data;
  } catch (error) {
    console.error('API Error:', error);
    throw error;
  }
}

// ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
function getToken() {
  return localStorage.getItem('authToken');
}

function setToken(token) {
  localStorage.setItem('authToken', token);
}

function removeToken() {
  localStorage.removeItem('authToken');
}

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDate(date, format = 'YYYY-MM-DD') {
  return dayjs(date).format(format);
}

// é€šçŸ¥è¡¨ç¤º
function showNotification(message, type = 'success') {
  Swal.fire({
    icon: type,
    title: message,
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 3000
  });
}

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
function handleError(error) {
  const message = error.response?.data?.error || error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
  showNotification(message, 'error');
}
```

---

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä»•æ§˜

### ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ

#### src/index.tsx
```typescript
import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { serveStatic } from 'hono/cloudflare-workers';
import type { Bindings } from './types';

// APIãƒ«ãƒ¼ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import auth from './routes/auth';
import healthLogs from './routes/health-logs';
import advices from './routes/advices';
import inquiries from './routes/inquiries';
import admin from './routes/admin';
import announcements from './routes/announcements';
import comments from './routes/comments';
import settings from './routes/settings';
import opinions from './routes/opinions';

const app = new Hono<{ Bindings: Bindings }>();

// CORSè¨­å®š
app.use('/api/*', cors());

// é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡
app.use('/static/*', serveStatic({ root: './public' }));

// APIãƒ«ãƒ¼ãƒˆç™»éŒ²
app.route('/api/auth', auth);
app.route('/api/health-logs', healthLogs);
app.route('/api/advices', advices);
app.route('/api/inquiries', inquiries);
app.route('/api/admin', admin);
app.route('/api/announcements', announcements);
app.route('/api/comments', comments);
app.route('/api/settings', settings);
app.route('/api/opinions', opinions);

// R2ç”»åƒå–å¾—
app.get('/api/images/:path{.+}', async (c) => {
  const path = c.req.param('path');
  const object = await c.env.BUCKET.get(path);
  if (!object) return c.notFound();
  return new Response(object.body, {
    headers: {
      'Content-Type': object.httpMetadata?.contentType || 'application/octet-stream',
      'Cache-Control': 'public, max-age=31536000',
    },
  });
});

// HTMLãƒšãƒ¼ã‚¸é…ä¿¡
app.get('/', async (c) => {
  return c.html(await Bun.file('./public/index.html').text());
});

app.get('/mypage', async (c) => {
  return c.html(await Bun.file('./public/mypage.html').text());
});

app.get('/admin', async (c) => {
  return c.html(await Bun.file('./public/admin.html').text());
});

export default app;
```

### APIãƒ«ãƒ¼ãƒˆè©³ç´°

#### 1. src/routes/auth.tsï¼ˆèªè¨¼APIï¼‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `POST /api/auth/login` - Googleãƒ­ã‚°ã‚¤ãƒ³
- `GET /api/auth/verify` - ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- `PUT /api/auth/profile` - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°

**ä¸»è¦å‡¦ç†**:
```typescript
import { Hono } from 'hono';
import { sign, verify } from '../lib/jwt';
import type { CloudflareBindings } from '../types';

const app = new Hono<{ Bindings: CloudflareBindings }>();

// Googleãƒ­ã‚°ã‚¤ãƒ³
app.post('/login', async (c) => {
  const { credential } = await c.req.json();
  
  // Google ID Tokenæ¤œè¨¼ï¼ˆOAuth2.0ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨ï¼‰
  const googleUser = await verifyGoogleToken(credential);
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã¾ãŸã¯ä½œæˆ
  let user = await c.env.DB.prepare(`
    SELECT * FROM users WHERE email = ?
  `).bind(googleUser.email).first();
  
  if (!user) {
    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    const result = await c.env.DB.prepare(`
      INSERT INTO users (email, name, auth_provider, auth_provider_id, avatar_url)
      VALUES (?, ?, 'google', ?, ?)
    `).bind(
      googleUser.email,
      googleUser.name,
      googleUser.sub,
      googleUser.picture
    ).run();
    
    user = await c.env.DB.prepare(`
      SELECT * FROM users WHERE id = ?
    `).bind(result.meta.last_row_id).first();
  }
  
  // JWTãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
  const token = await sign({
    userId: user.id,
    email: user.email,
    role: user.role
  }, c.env.JWT_SECRET);
  
  return c.json({
    success: true,
    token,
    user
  });
});

// ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
app.get('/verify', async (c) => {
  const authHeader = c.req.header('Authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return c.json({ success: false, error: 'No token' }, 401);
  }
  
  const token = authHeader.substring(7);
  const payload = await verify(token, c.env.JWT_SECRET);
  
  const user = await c.env.DB.prepare(`
    SELECT * FROM users WHERE id = ?
  `).bind(payload.userId).first();
  
  return c.json({ success: true, user });
});

export default app;
```

#### 2. src/routes/health-logs.tsï¼ˆå¥åº·ãƒ­ã‚°APIï¼‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `POST /api/health-logs` - å¥åº·ãƒ­ã‚°ä½œæˆãƒ»æ›´æ–°
- `GET /api/health-logs/:date` - ç‰¹å®šæ—¥ã®ãƒ­ã‚°å–å¾—
- `GET /api/health-logs/range` - æœŸé–“æŒ‡å®šã§ãƒ­ã‚°å–å¾—
- `POST /api/health-logs/analyze-meal-photo` - é£Ÿäº‹å†™çœŸAIåˆ†æ

**AIåˆ†æå‡¦ç†**:
```typescript
// Gemini APIã§é£Ÿäº‹å†™çœŸã‚’åˆ†æ
async function analyzeMealPhoto(photoBase64: string, apiKey: string) {
  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-vision:generateContent?key=${apiKey}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: "ã“ã®é£Ÿäº‹ã®å†™çœŸã‚’åˆ†æã—ã¦ã€ã‚«ãƒ­ãƒªãƒ¼ã€ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã€ç‚­æ°´åŒ–ç‰©ã€è„‚è³ªã‚’æ¨å®šã—ã¦ãã ã•ã„ã€‚JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚" },
            { inline_data: { mime_type: "image/jpeg", data: photoBase64 } }
          ]
        }],
        generationConfig: {
          temperature: 0.4,
          topK: 32,
          topP: 1,
          maxOutputTokens: 1024
        }
      })
    }
  );
  
  const data = await response.json();
  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦æ „é¤Šç´ ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
  return parseNutritionData(data);
}
```

**éåŒæœŸAIåˆ†æ**:
```typescript
// executionContext.waitUntil()ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†
app.post('/', async (c) => {
  // ... å¥åº·ãƒ­ã‚°ä¿å­˜ ...
  
  // AIåˆ†æã‚’éåŒæœŸå®Ÿè¡Œï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
  c.executionCtx.waitUntil(
    generateAIAdvice(c.env.DB, c.env.GEMINI_API_KEY, userId, logDate, healthData)
  );
  
  return c.json({ success: true, log_id: logId });
});

async function generateAIAdvice(db, apiKey, userId, logDate, healthData) {
  // Gemini APIã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
  const prompt = `
    ä»¥ä¸‹ã®å¥åº·ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’3ã¤æä¾›ã—ã¦ãã ã•ã„ï¼š
    - ä½“é‡: ${healthData.weight}kg
    - ã‚«ãƒ­ãƒªãƒ¼: ${healthData.calories}kcal
    - é‹å‹•æ™‚é–“: ${healthData.exercise_minutes}åˆ†
    ...
  `;
  
  const advice = await callGeminiAPI(apiKey, prompt);
  
  // advicesãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
  await db.prepare(`
    INSERT INTO advices (user_id, staff_name, advice_type, title, content, log_date, advice_source, confidence_score)
    VALUES (?, 'AI Assistant', ?, ?, ?, ?, 'ai', ?)
  `).bind(userId, advice.type, advice.title, advice.content, logDate, advice.confidence).run();
}
```

#### 3. src/routes/advices.tsï¼ˆã‚¢ãƒ‰ãƒã‚¤ã‚¹APIï¼‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `GET /api/advices` - è‡ªåˆ†ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ä¸€è¦§
- `PUT /api/advices/:id/read` - ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ—¢èª­åŒ–
- `GET /api/advices/unread-count` - æœªèª­ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ•°

#### 4. src/routes/announcements.tsï¼ˆãŠçŸ¥ã‚‰ã›APIï¼‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `GET /api/announcements` - å…¬é–‹ä¸­ã®ãŠçŸ¥ã‚‰ã›ä¸€è¦§
- `POST /api/announcements/admin` - ãŠçŸ¥ã‚‰ã›ä½œæˆï¼ˆç®¡ç†è€…ï¼‰
- `PUT /api/announcements/admin/:id` - ãŠçŸ¥ã‚‰ã›æ›´æ–°ï¼ˆç®¡ç†è€…ï¼‰
- `DELETE /api/announcements/admin/:id` - ãŠçŸ¥ã‚‰ã›å‰Šé™¤ï¼ˆç®¡ç†è€…ï¼‰

---

## AIçµ±åˆä»•æ§˜

### Gemini APIçµ±åˆ

#### 1. é£Ÿäº‹å†™çœŸåˆ†æï¼ˆGemini 1.5 Pro Visionï¼‰

**ãƒ¢ãƒ‡ãƒ«**: `gemini-1.5-pro-vision`

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹**:
```
ã“ã®é£Ÿäº‹ã®å†™çœŸã‚’åˆ†æã—ã¦ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’JSONå½¢å¼ã§æä¾›ã—ã¦ãã ã•ã„ï¼š
{
  "calories": ã‚«ãƒ­ãƒªãƒ¼ï¼ˆkcalï¼‰,
  "protein": ã‚¿ãƒ³ãƒ‘ã‚¯è³ªï¼ˆgï¼‰,
  "carbs": ç‚­æ°´åŒ–ç‰©ï¼ˆgï¼‰,
  "fat": è„‚è³ªï¼ˆgï¼‰,
  "description": "é£Ÿäº‹ã®èª¬æ˜",
  "confidence": ä¿¡é ¼åº¦ï¼ˆ0-1ï¼‰
}

æ³¨æ„:
- è¦‹ãˆã‚‹é£Ÿæã‹ã‚‰æœ€ã‚‚æ­£ç¢ºãªæ¨å®šã‚’è¡Œã£ã¦ãã ã•ã„
- ä¸ç¢ºå®Ÿãªå ´åˆã¯ä½ã‚ã®ä¿¡é ¼åº¦ã‚’è¿”ã—ã¦ãã ã•ã„
- æ—¥æœ¬é£Ÿã®æ „é¤Šç´ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‚ç…§ã—ã¦ãã ã•ã„
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†**:
```typescript
function parseNutritionData(geminiResponse: any) {
  try {
    const text = geminiResponse.candidates[0].content.parts[0].text;
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      return JSON.parse(jsonMatch[0]);
    }
  } catch (error) {
    console.error('Failed to parse Gemini response:', error);
  }
  
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™
  return {
    calories: 500,
    protein: 20,
    carbs: 60,
    fat: 15,
    description: "åˆ†æã§ãã¾ã›ã‚“ã§ã—ãŸ",
    confidence: 0.3
  };
}
```

#### 2. å¥åº·ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆï¼ˆGemini 1.5 Flashï¼‰

**ãƒ¢ãƒ‡ãƒ«**: `gemini-1.5-flash`

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹**:
```
ã‚ãªãŸã¯å°‚é–€ã®å¥åº·ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®å¥åº·ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€å…·ä½“çš„ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ã€å¥åº·ãƒ‡ãƒ¼ã‚¿ã€‘
æ—¥ä»˜: ${logDate}
ä½“é‡: ${weight}kg (BMI: ${bmi})
ä½“è„‚è‚ªç‡: ${bodyFat}%
ã‚«ãƒ­ãƒªãƒ¼æ‘‚å–: ${calories}kcal
ã‚¿ãƒ³ãƒ‘ã‚¯è³ª: ${protein}g
ç‚­æ°´åŒ–ç‰©: ${carbs}g
è„‚è³ª: ${fat}g
é‹å‹•æ™‚é–“: ${exerciseMinutes}åˆ†
ç¡çœ æ™‚é–“: ${sleepHours}æ™‚é–“
ä½“èª¿è©•ä¾¡: ${conditionRating}/5

ã€éå»7æ—¥é–“ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã€‘
ä½“é‡å¤‰åŒ–: ${weightTrend}
å¹³å‡ã‚«ãƒ­ãƒªãƒ¼: ${avgCalories}kcal
å¹³å‡é‹å‹•æ™‚é–“: ${avgExercise}åˆ†

ã€å‡ºåŠ›å½¢å¼ã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã§3ã¤ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¿”ã—ã¦ãã ã•ã„ï¼š
[
  {
    "type": "nutrition" | "exercise" | "sleep" | "general",
    "title": "ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰",
    "content": "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹å†…å®¹ï¼ˆ150æ–‡å­—ä»¥å†…ï¼‰",
    "confidence": 0-1ã®ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢
  }
]

è¦ä»¶:
- å…·ä½“çš„ã§å®Ÿè·µå¯èƒ½ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹
- ãƒã‚¸ãƒ†ã‚£ãƒ–ãªãƒˆãƒ¼ãƒ³
- æ•°å€¤ã‚’å«ã‚ã‚‹
- å°‚é–€ç”¨èªã¯é¿ã‘ã‚‹
```

**ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°**:
```typescript
function calculateConfidenceScore(healthData: HealthData): number {
  let score = 0.5; // ãƒ™ãƒ¼ã‚¹ã‚¹ã‚³ã‚¢
  
  // ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯
  if (healthData.weight) score += 0.1;
  if (healthData.calories > 0) score += 0.1;
  if (healthData.exerciseMinutes > 0) score += 0.1;
  if (healthData.sleepHours) score += 0.1;
  
  // éå»ãƒ‡ãƒ¼ã‚¿ã®æœ‰ç„¡
  if (healthData.historicalData?.length > 7) score += 0.1;
  
  return Math.min(score, 1.0);
}
```

#### 3. APIãƒ¬ãƒ¼ãƒˆåˆ¶é™

**ã‚¯ã‚©ãƒ¼ã‚¿ç®¡ç†**:
```typescript
// 1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Šã®AIåˆ†æä¸Šé™
const AI_ANALYSIS_LIMITS = {
  MEAL_PHOTO_PER_DAY: 15,     // é£Ÿäº‹å†™çœŸåˆ†æ: 1æ—¥15å›
  ADVICE_GENERATION_PER_DAY: 3 // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ: 1æ—¥3å›
};

async function checkAIQuota(db: D1Database, userId: number, type: string): Promise<boolean> {
  const today = new Date().toISOString().split('T')[0];
  
  const count = await db.prepare(`
    SELECT COUNT(*) as count FROM ai_usage_logs
    WHERE user_id = ? AND usage_type = ? AND DATE(created_at) = ?
  `).bind(userId, type, today).first();
  
  const limit = type === 'meal_photo' 
    ? AI_ANALYSIS_LIMITS.MEAL_PHOTO_PER_DAY 
    : AI_ANALYSIS_LIMITS.ADVICE_GENERATION_PER_DAY;
  
  return count.count < limit;
}
```

---

## èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### JWTèªè¨¼

**ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ**:
```typescript
// src/lib/jwt.ts
import { SignJWT, jwtVerify } from 'jose';

export async function sign(payload: any, secret: string): Promise<string> {
  const encoder = new TextEncoder();
  const secretKey = encoder.encode(secret);
  
  return await new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('7d') // 7æ—¥é–“æœ‰åŠ¹
    .sign(secretKey);
}

export async function verify(token: string, secret: string): Promise<any> {
  const encoder = new TextEncoder();
  const secretKey = encoder.encode(secret);
  
  const { payload } = await jwtVerify(token, secretKey);
  return payload;
}
```

**ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**:
```typescript
// èªè¨¼å¿…é ˆã®ãƒ«ãƒ¼ãƒˆã§ä½¿ç”¨
async function requireAuth(c: Context) {
  const authHeader = c.req.header('Authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return c.json({ success: false, error: 'Unauthorized' }, 401);
  }
  
  const token = authHeader.substring(7);
  try {
    const payload = await verify(token, c.env.JWT_SECRET);
    c.set('user', payload);
    return;
  } catch (error) {
    return c.json({ success: false, error: 'Invalid token' }, 401);
  }
}

// ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
async function requireAdmin(c: Context) {
  const user = c.get('user');
  if (!user || !['admin', 'superadmin'].includes(user.role)) {
    return c.json({ success: false, error: 'Forbidden' }, 403);
  }
}
```

### CORSè¨­å®š

```typescript
app.use('/api/*', cors({
  origin: [
    'http://localhost:3000',
    'https://furdi-hikone.pages.dev',
    'https://your-custom-domain.com'
  ],
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowHeaders: ['Content-Type', 'Authorization'],
  exposeHeaders: ['Content-Length'],
  maxAge: 600,
  credentials: true
}));
```

### XSSå¯¾ç­–

**å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚º**:
```typescript
function sanitizeInput(input: string): string {
  return input
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«é©ç”¨
app.post('/api/health-logs', async (c) => {
  const body = await c.req.json();
  body.condition_note = sanitizeInput(body.condition_note);
  // ...
});
```

### SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

**Prepared Statementsä½¿ç”¨**:
```typescript
// âœ… æ­£ã—ã„ï¼ˆPrepared Statementsï¼‰
await db.prepare(`
  SELECT * FROM users WHERE email = ?
`).bind(email).first();

// âŒ å±é™ºï¼ˆç›´æ¥æ–‡å­—åˆ—çµåˆï¼‰
await db.prepare(`
  SELECT * FROM users WHERE email = '${email}'
`).first();
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

**é‡è¦ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
CREATE INDEX idx_users_email ON users(email);

-- å¥åº·ãƒ­ã‚°å–å¾—
CREATE INDEX idx_health_logs_user_date ON health_logs(user_id, log_date);

-- ã‚¢ãƒ‰ãƒã‚¤ã‚¹å–å¾—
CREATE INDEX idx_advices_user ON advices(user_id, created_at DESC);

-- æœªèª­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
CREATE INDEX idx_advices_read ON advices(user_id, is_read);
```

### N+1ã‚¯ã‚¨ãƒªå›é¿

**JOINã‚’ä½¿ç”¨**:
```typescript
// âœ… åŠ¹ç‡çš„ï¼ˆ1ã‚¯ã‚¨ãƒªï¼‰
const logs = await db.prepare(`
  SELECT 
    hl.*,
    SUM(m.calories) as total_calories,
    SUM(m.protein) as total_protein,
    SUM(m.carbs) as total_carbs,
    SUM(m.fat) as total_fat
  FROM health_logs hl
  LEFT JOIN meals m ON hl.id = m.health_log_id
  WHERE hl.user_id = ?
  GROUP BY hl.id
  ORDER BY hl.log_date DESC
`).bind(userId).all();

// âŒ éåŠ¹ç‡ï¼ˆN+1ã‚¯ã‚¨ãƒªï¼‰
const logs = await db.prepare(`SELECT * FROM health_logs WHERE user_id = ?`).bind(userId).all();
for (const log of logs) {
  const meals = await db.prepare(`SELECT * FROM meals WHERE health_log_id = ?`).bind(log.id).all();
  // ...
}
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

**R2ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥**:
```typescript
app.get('/api/images/:path{.+}', async (c) => {
  const path = c.req.param('path');
  const object = await c.env.BUCKET.get(path);
  
  if (!object) return c.notFound();
  
  return new Response(object.body, {
    headers: {
      'Content-Type': object.httpMetadata?.contentType || 'application/octet-stream',
      'Cache-Control': 'public, max-age=31536000', // 1å¹´é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      'ETag': object.etag
    },
  });
});
```

**APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥**:
```typescript
// Cloudflare Workersã®è‡ªå‹•ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨
app.get('/api/announcements', async (c) => {
  const { results } = await c.env.DB.prepare(`
    SELECT * FROM announcements 
    WHERE is_published = 1 
    ORDER BY published_at DESC 
    LIMIT 10
  `).all();
  
  return c.json({ success: true, data: results }, {
    headers: {
      'Cache-Control': 'public, max-age=300' // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    }
  });
});
```

### ç”»åƒæœ€é©åŒ–

**ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®ãƒªã‚µã‚¤ã‚º**:
```typescript
async function uploadMealPhoto(photoBlob: Blob, mealId: number): Promise<string> {
  // ç”»åƒã‚’800x800ã«ãƒªã‚µã‚¤ã‚º
  const resizedBlob = await resizeImage(photoBlob, 800, 800);
  
  // WebPå½¢å¼ã«å¤‰æ›ï¼ˆ70%å“è³ªï¼‰
  const webpBlob = await convertToWebP(resizedBlob, 0.7);
  
  // R2ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const key = `meals/${mealId}/${Date.now()}.webp`;
  await bucket.put(key, webpBlob);
  
  return key;
}
```

---

## ç’°å¢ƒå¤‰æ•°

### å¿…é ˆç’°å¢ƒå¤‰æ•°

| å¤‰æ•°å | èª¬æ˜ | ä¾‹ |
|--------|------|-----|
| `GOOGLE_CLIENT_ID` | Google OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID | `123456789.apps.googleusercontent.com` |
| `GOOGLE_CLIENT_SECRET` | Google OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | `GOCSPX-xxx` |
| `JWT_SECRET` | JWTç½²åç”¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆ32æ–‡å­—ä»¥ä¸Šï¼‰ | `your_super_secret_key_min_32_chars` |
| `GEMINI_API_KEY` | Gemini APIã‚­ãƒ¼ | `AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXX` |

### Cloudflareãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°

**wrangler.jsonc**:
```jsonc
{
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "furdi-hikone-production",
      "database_id": "your-database-id"
    }
  ],
  "r2_buckets": [
    {
      "binding": "BUCKET",
      "bucket_name": "furdi-hikone-photos"
    }
  ]
}
```

**TypeScriptå‹å®šç¾©**:
```typescript
// src/types/index.ts
export interface CloudflareBindings {
  DB: D1Database;
  BUCKET: R2Bucket;
  JWT_SECRET: string;
  GOOGLE_CLIENT_ID: string;
  GOOGLE_CLIENT_SECRET: string;
  GEMINI_API_KEY: string;
}
```

---

## ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤

### ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹

```bash
# 1. TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ« + Viteãƒãƒ³ãƒ‰ãƒ«
npm run build

# å‡ºåŠ›:
# dist/
#   _worker.js      # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿Hono Worker
#   _routes.json    # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
#   static/         # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰
```

**vite.config.ts**:
```typescript
import { defineConfig } from 'vite';
import pages from '@hono/vite-cloudflare-pages';

export default defineConfig({
  plugins: [pages()],
  build: {
    outDir: 'dist',
    minify: 'esbuild',
    target: 'esnext'
  }
});
```

### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
npm run build
pm2 start ecosystem.config.cjs

# æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
npm run build
npx wrangler pages deploy dist --project-name furdi-hikone
```

---

## ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚°

### Cloudflare Workersãƒ­ã‚°

```bash
# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°
npx wrangler tail furdi-hikone

# ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
npx wrangler tail furdi-hikone --status error
npx wrangler tail furdi-hikone --method POST
```

### ã‚¨ãƒ©ãƒ¼å‡¦ç†

```typescript
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
app.onError((err, c) => {
  console.error('Error:', err);
  
  return c.json({
    success: false,
    error: err.message || 'Internal Server Error'
  }, 500);
});

// 404ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
app.notFound((c) => {
  return c.json({
    success: false,
    error: 'Not Found'
  }, 404);
});
```

---

**ä½œæˆæ—¥**: 2025å¹´11æœˆ13æ—¥  
**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ13æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
